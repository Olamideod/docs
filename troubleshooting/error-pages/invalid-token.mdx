# Invalid Token Error Troubleshooting

This guide helps you resolve issues related to invalid or expired authentication tokens in Protekt.

## Common Invalid Token Scenarios

### JWT Token Expired

**Error Message:**
```
{
  "error": "invalid_token",
  "error_description": "Token has expired",
  "status": 401
}
```

**Causes:**
- Token has passed its expiration time
- Clock skew between client and server
- Token was issued with a short expiration time

**Solutions:**

1. **Refresh the Token**
   ```javascript
   // Using the refresh token to get a new access token
   const refreshToken = async (refreshToken) => {
     try {
       const response = await fetch('https://api.protekt.com/oauth/token', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json',
         },
         body: JSON.stringify({
           grant_type: 'refresh_token',
           refresh_token: refreshToken,
           client_id: 'your-client-id'
         })
       });
       
       const data = await response.json();
       return data.access_token;
     } catch (error) {
       console.error('Token refresh failed:', error);
       // Redirect to login
       window.location.href = '/login';
     }
   };
   ```

2. **Check Token Expiration**
   ```javascript
   // Decode and check JWT token expiration
   const checkTokenExpiration = (token) => {
     try {
       const payload = JSON.parse(atob(token.split('.')[1]));
       const currentTime = Math.floor(Date.now() / 1000);
       
       if (payload.exp < currentTime) {
         console.log('Token expired, refreshing...');
         return refreshToken(localStorage.getItem('refresh_token'));
       }
       
       return token;
     } catch (error) {
       console.error('Invalid token format:', error);
       return null;
     }
   };
   ```

### Invalid Token Format

**Error Message:**
```
{
  "error": "invalid_token",
  "error_description": "Malformed token",
  "status": 401
}
```

**Causes:**
- Token is not a valid JWT format
- Token is corrupted or incomplete
- Token contains invalid characters

**Solutions:**

1. **Validate Token Format**
   ```javascript
   // Validate JWT token format
   const isValidJWT = (token) => {
     if (!token || typeof token !== 'string') {
       return false;
     }
     
     const parts = token.split('.');
     if (parts.length !== 3) {
       return false;
     }
     
     // Check if parts are valid base64
     try {
       parts.forEach(part => {
         if (part) {
           atob(part.replace(/-/g, '+').replace(/_/g, '/'));
         }
       });
       return true;
     } catch (error) {
       return false;
     }
   };
   ```

2. **Token Storage Best Practices**
   ```javascript
   // Secure token storage
   class TokenManager {
     static setToken(token) {
       if (isValidJWT(token)) {
         localStorage.setItem('access_token', token);
         return true;
       }
       return false;
     }
     
     static getToken() {
       const token = localStorage.getItem('access_token');
       return isValidJWT(token) ? token : null;
     }
     
     static clearTokens() {
       localStorage.removeItem('access_token');
       localStorage.removeItem('refresh_token');
     }
   }
   ```

### Token Signature Verification Failed

**Error Message:**
```
{
  "error": "invalid_token",
  "error_description": "Token signature verification failed",
  "status": 401
}
```

**Causes:**
- Token was signed with a different secret/key
- Token has been tampered with
- Wrong algorithm used for verification

**Solutions:**

1. **Verify Token Signature**
   ```javascript
   // Verify JWT signature (client-side example)
   const verifyTokenSignature = async (token, publicKey) => {
     try {
       const response = await fetch('https://api.protekt.com/oauth/verify', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json',
         },
         body: JSON.stringify({ token })
       });
       
       return response.ok;
     } catch (error) {
       console.error('Token verification failed:', error);
       return false;
     }
   };
   ```

2. **Check Token Issuer**
   ```javascript
   // Verify token issuer
   const verifyTokenIssuer = (token) => {
     try {
       const payload = JSON.parse(atob(token.split('.')[1]));
       return payload.iss === 'https://protekt.com';
     } catch (error) {
       return false;
     }
   };
   ```

## API Integration Examples

### Express.js Middleware

```javascript
// Express middleware for token validation
const validateToken = async (req, res, next) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (!token) {
    return res.status(401).json({
      error: 'missing_token',
      error_description: 'No token provided'
    });
  }
  
  try {
    // Verify token with Protekt API
    const response = await fetch('https://api.protekt.com/oauth/introspect', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.PROTEKT_API_TOKEN}`
      },
      body: JSON.stringify({ token })
    });
    
    const data = await response.json();
    
    if (!data.active) {
      return res.status(401).json({
        error: 'invalid_token',
        error_description: 'Token is not active'
      });
    }
    
    req.user = data;
    next();
  } catch (error) {
    console.error('Token validation error:', error);
    return res.status(401).json({
      error: 'invalid_token',
      error_description: 'Token validation failed'
    });
  }
};

// Usage
app.use('/api/protected', validateToken);
```

### React Hook for Token Management

```javascript
// React hook for token management
import { useState, useEffect, useCallback } from 'react';

const useAuth = () => {
  const [token, setToken] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const login = useCallback(async (credentials) => {
    try {
      setLoading(true);
      const response = await fetch('https://api.protekt.com/oauth/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          grant_type: 'password',
          username: credentials.username,
          password: credentials.password,
          client_id: process.env.REACT_APP_CLIENT_ID
        })
      });

      const data = await response.json();
      
      if (response.ok) {
        setToken(data.access_token);
        localStorage.setItem('refresh_token', data.refresh_token);
        setError(null);
      } else {
        setError(data.error_description);
      }
    } catch (error) {
      setError('Login failed');
    } finally {
      setLoading(false);
    }
  }, []);

  const logout = useCallback(() => {
    setToken(null);
    localStorage.removeItem('refresh_token');
  }, []);

  const refreshToken = useCallback(async () => {
    const refreshToken = localStorage.getItem('refresh_token');
    if (!refreshToken) {
      logout();
      return;
    }

    try {
      const response = await fetch('https://api.protekt.com/oauth/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          grant_type: 'refresh_token',
          refresh_token: refreshToken,
          client_id: process.env.REACT_APP_CLIENT_ID
        })
      });

      const data = await response.json();
      
      if (response.ok) {
        setToken(data.access_token);
        localStorage.setItem('refresh_token', data.refresh_token);
      } else {
        logout();
      }
    } catch (error) {
      logout();
    }
  }, [logout]);

  useEffect(() => {
    // Check for existing token on mount
    const existingToken = localStorage.getItem('access_token');
    if (existingToken) {
      setToken(existingToken);
    }
    setLoading(false);
  }, []);

  return { token, loading, error, login, logout, refreshToken };
};
```

## Error Handling Strategies

### Graceful Degradation

```javascript
// Handle token errors gracefully
const handleTokenError = (error, router) => {
  switch (error.error) {
    case 'invalid_token':
      if (error.error_description.includes('expired')) {
        // Try to refresh token
        return refreshToken();
      } else {
        // Token is invalid, redirect to login
        router.push('/login');
      }
      break;
      
    case 'insufficient_scope':
      // User doesn't have required permissions
      router.push('/unauthorized');
      break;
      
    default:
      // Unknown error, redirect to login
      router.push('/login');
  }
};
```

### Retry Logic

```javascript
// Retry API calls with token refresh
const apiCallWithRetry = async (apiCall, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await apiCall();
    } catch (error) {
      if (error.status === 401 && i < maxRetries - 1) {
        // Token might be expired, try to refresh
        await refreshToken();
        continue;
      }
      throw error;
    }
  }
};
```

## Debugging Tools

### Token Inspector

```javascript
// Debug token contents
const inspectToken = (token) => {
  try {
    const parts = token.split('.');
    const header = JSON.parse(atob(parts[0]));
    const payload = JSON.parse(atob(parts[1]));
    
    console.log('Token Header:', header);
    console.log('Token Payload:', payload);
    console.log('Expiration:', new Date(payload.exp * 1000));
    console.log('Issued At:', new Date(payload.iat * 1000));
    
    return { header, payload };
  } catch (error) {
    console.error('Failed to inspect token:', error);
    return null;
  }
};
```

### Network Monitoring

```javascript
// Monitor token-related requests
const monitorTokenRequests = () => {
  const originalFetch = window.fetch;
  
  window.fetch = function(...args) {
    const [url, options] = args;
    
    if (url.includes('/oauth/token') || url.includes('/introspect')) {
      console.log('Token request:', { url, options });
    }
    
    return originalFetch.apply(this, args).then(response => {
      if (response.status === 401) {
        console.warn('401 response detected:', response);
      }
      return response;
    });
  };
};
```

## Best Practices

1. **Always validate tokens** before using them
2. **Implement proper token refresh logic**
3. **Store tokens securely** (httpOnly cookies for web apps)
4. **Handle token errors gracefully** with user-friendly messages
5. **Monitor token expiration** and refresh proactively
6. **Use HTTPS** for all token-related communications
7. **Implement proper logout** to clear all tokens
8. **Add retry logic** for transient token issues
9. **Log token errors** for debugging and monitoring
10. **Test token scenarios** in your development environment

## Support Resources

- **API Documentation**: [https://docs.protekt.com/reference/authentication](https://docs.protekt.com/reference/authentication)
- **Token Debugger**: [https://jwt.io](https://jwt.io)
- **Support Email**: support@protekt.com
- **Community Forum**: [https://community.protekt.com](https://community.protekt.com) 